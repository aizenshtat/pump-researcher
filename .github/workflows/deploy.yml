name: Deploy to Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Create deployment directory
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "mkdir -p /opt/pump-researcher"

      - name: Copy files to server
        run: |
          scp -r docker-compose.yml docker-compose.prod.yml Dockerfile Dockerfile.prod \
            requirements.txt src scripts deploy alembic \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:/opt/pump-researcher/

      - name: Create .env file on server
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "cat > /opt/pump-researcher/.env << 'EOF'
          ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}
          REDDIT_CLIENT_ID=${{ secrets.REDDIT_CLIENT_ID }}
          REDDIT_CLIENT_SECRET=${{ secrets.REDDIT_CLIENT_SECRET }}
          TELEGRAM_API_ID=${{ secrets.TELEGRAM_API_ID }}
          TELEGRAM_API_HASH=${{ secrets.TELEGRAM_API_HASH }}
          TELEGRAM_PHONE_NUMBER=${{ secrets.TELEGRAM_PHONE_NUMBER }}
          TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}
          TWITTER_USERNAME=${{ secrets.TWITTER_USERNAME }}
          TWITTER_PASSWORD=${{ secrets.TWITTER_PASSWORD }}
          TWITTER_EMAIL=${{ secrets.TWITTER_EMAIL }}
          DISCORD_EMAIL=${{ secrets.DISCORD_EMAIL }}
          DISCORD_PASSWORD=${{ secrets.DISCORD_PASSWORD }}
          COINMARKETCAP_API_KEY=${{ secrets.COINMARKETCAP_API_KEY }}
          COINMARKETCAP_SUBSCRIPTION_LEVEL=${{ secrets.COINMARKETCAP_SUBSCRIPTION_LEVEL }}
          BINANCE_API_KEY=${{ secrets.BINANCE_API_KEY }}
          BINANCE_API_SECRET=${{ secrets.BINANCE_API_SECRET }}
          BINANCE_TESTNET=false
          XAI_API_KEY=${{ secrets.XAI_API_KEY }}
          PUMP_THRESHOLD_PCT=${{ vars.PUMP_THRESHOLD_PCT || '5.0' }}
          PUMP_TIME_WINDOW_MINUTES=${{ vars.PUMP_TIME_WINDOW_MINUTES || '60' }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD || 'pump_secret_prod' }}
          EOF"

      - name: Initial server setup (if needed)
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "
            if ! command -v docker &> /dev/null || ! [ -f /etc/letsencrypt/live/${{ secrets.SERVER_DOMAIN }}/fullchain.pem ]; then
              echo 'Running initial server setup...'
              chmod +x /opt/pump-researcher/deploy/setup-server.sh
              CERTBOT_EMAIL=${{ secrets.CERTBOT_EMAIL }} DOMAIN=${{ secrets.SERVER_DOMAIN }} /opt/pump-researcher/deploy/setup-server.sh
            fi
          "

      - name: Build and deploy containers
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "
            cd /opt/pump-researcher
            docker compose -f docker-compose.prod.yml build
            docker compose -f docker-compose.prod.yml up -d
            docker compose -f docker-compose.prod.yml ps
            # Cleanup old images and build cache
            docker system prune -af
          "

      - name: Verify deployment
        run: |
          sleep 10
          curl -sSf https://${{ secrets.SERVER_DOMAIN }} > /dev/null
          echo "âœ“ Deployment successful: https://${{ secrets.SERVER_DOMAIN }}"
