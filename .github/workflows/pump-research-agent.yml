name: Pump Research Agent

on:
  schedule:
    # Run every hour
    - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      debug:
        description: 'Enable debug mode'
        required: false
        default: 'false'

jobs:
  research:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ hashFiles('Dockerfile') }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          load: true
          tags: pump-researcher:latest
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max

      - name: Run Pump Research Agent
        run: |
          docker run --rm \
            -e ANTHROPIC_API_KEY="${{ secrets.ANTHROPIC_API_KEY }}" \
            -e REDDIT_CLIENT_ID="${{ secrets.REDDIT_CLIENT_ID }}" \
            -e REDDIT_CLIENT_SECRET="${{ secrets.REDDIT_CLIENT_SECRET }}" \
            -e TELEGRAM_API_ID="${{ secrets.TELEGRAM_API_ID }}" \
            -e TELEGRAM_API_HASH="${{ secrets.TELEGRAM_API_HASH }}" \
            -e TELEGRAM_PHONE_NUMBER="${{ secrets.TELEGRAM_PHONE_NUMBER }}" \
            -e TELEGRAM_CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -e TWITTER_USERNAME="${{ secrets.TWITTER_USERNAME }}" \
            -e TWITTER_PASSWORD="${{ secrets.TWITTER_PASSWORD }}" \
            -e TWITTER_EMAIL="${{ secrets.TWITTER_EMAIL }}" \
            -e DISCORD_EMAIL="${{ secrets.DISCORD_EMAIL }}" \
            -e DISCORD_PASSWORD="${{ secrets.DISCORD_PASSWORD }}" \
            -e DISCORD_HEADLESS=true \
            -e COINMARKETCAP_API_KEY="${{ secrets.COINMARKETCAP_API_KEY }}" \
            -e COINMARKETCAP_SUBSCRIPTION_LEVEL="${{ secrets.COINMARKETCAP_SUBSCRIPTION_LEVEL }}" \
            -e BINANCE_API_KEY="${{ secrets.BINANCE_API_KEY }}" \
            -e BINANCE_API_SECRET="${{ secrets.BINANCE_API_SECRET }}" \
            -e BINANCE_TESTNET=false \
            -e XAI_API_KEY="${{ secrets.XAI_API_KEY }}" \
            -v ${{ github.workspace }}/data:/app/data \
            pump-researcher:latest

      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      - name: Upload database artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: research-db-${{ github.run_number }}
          path: data/research.db
          retention-days: 30

      - name: Summary
        if: always()
        run: |
          echo "## Pump Research Agent Run" >> $GITHUB_STEP_SUMMARY
          echo "- **Run Number:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          if [ -f data/research.db ]; then
            echo "- **Database:** Saved as artifact" >> $GITHUB_STEP_SUMMARY
          fi
